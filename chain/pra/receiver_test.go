package pra

import (
	"encoding/json"
	"errors"
	"fmt"
	"io/ioutil"
	"testing"

	"github.com/centrifuge/go-substrate-rpc-client/v3/types"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/icon-project/btp/chain"
	"github.com/icon-project/btp/chain/pra/binding"
	"github.com/icon-project/btp/chain/pra/mocks"
	"github.com/icon-project/btp/common/log"
	"github.com/stretchr/testify/assert"
	mock "github.com/stretchr/testify/mock"
	"github.com/stretchr/testify/require"
)

type blockinfo struct {
	BlockNumber            uint64
	Hash                   SubstrateHash
	Header                 SubstrateHeader
	ScaleEncodedHeader     []byte
	MetaData               SubstrateMetaData
	StorageKey             SubstrateStorageKey
	SystemEventsStorageRaw SubstrateStorageDataRaw
	SystemEventsReadProof  ReadProof
}

func readBlockInfoFromAssets(path string, bi *blockinfo) error {
	b, err := ioutil.ReadFile(path)
	if err != nil {
		panic(err)
	}

	return json.Unmarshal(b, &bi)
}

func TestReceiver_ReceiveLoop(t *testing.T) {
	t.Run("should monitor from the given height", func(t *testing.T) {
		subClient := &MockSubstrateClient{}
		r := &Receiver{
			l: log.New(),
			c: &Client{
				subClient:         subClient,
				stopMonitorSignal: make(chan bool),
			},
		}

		bi := &blockinfo{}
		require.NoError(t, readBlockInfoFromAssets("assets/moonbase_blockinfo_243221.json", bi))

		subClient.On("GetFinalizedHead").Return(bi.Hash, nil).Once()
		subClient.On("GetHeader", bi.Hash).Return(&bi.Header, nil).Twice()
		subClient.On("GetBlockHash", uint64(bi.BlockNumber)).Return(bi.Hash, nil).Once()
		subClient.On("GetMetadata", bi.Hash).Return(&bi.MetaData, nil).Once()
		subClient.On("GetStorageRaw", bi.StorageKey, bi.Hash).Return(&bi.SystemEventsStorageRaw, nil).Once()

		err := r.ReceiveLoop(243221, 1, func(bu *chain.BlockUpdate, rps []*chain.ReceiptProof) {
			assert.EqualValues(t, bu.Height, 243221)
			assert.Equal(t, bi.Hash.Hex(), fmt.Sprintf("0x%x", bu.BlockHash))
			assert.Equal(t,
				fmt.Sprintf("0x%x", bi.ScaleEncodedHeader),
				fmt.Sprintf("0x%x", bu.Header),
			)
			assert.Equal(t, "0xf90140b9013b4b6ca5b74e19d4bc04280edf20a53a4ebe1402cbb2ef7ed9a1611fb8411a33ca56d80e006415ef11020701d83ae5456ccecb3685eb39acc6b52d3e481214d8f1aa6b5465e347562ba9c7c993862047e1d6f020c25ab4139676afbf7170c254e2f36cefe70c046e6d62738060eed538a43e6738f4c560c5d950be96c72ad591f0c16f564c003b5c7b895c0e0466726f6e890101f7b9c5fb3f5b72f937ed511b173e5a39b9fb3ffaa1cc4dd024a4c7c36c7da8610847fec28647d5f0806548f385257170d76cf6e890f7467ef33b36dcc5b9be1b15d0fdb267aa2fce057cc81a0e2397f5a32ffd8637753f7d0c0c0b7289b002dc3f056e6d627301019a1b7069e8aa71015a15925595589999890dba42cb87dae2b5aabfee791bad47d380392c626eef34701ea3a95d7dd4fc891759cb375991aacbc1ee3663742289f800",
				fmt.Sprintf("0x%x", bu.Proof),
			)
			r.StopReceiveLoop()
		}, func() {})

		assert.NoError(t, err)
	})

	t.Run("should call bmc.parseMessage when Parachain emits EVM Log", func(t *testing.T) {
		subClient := &MockSubstrateClient{}
		bmcContract := &mocks.BMCContract{}
		r := &Receiver{
			l: log.New(),
			c: &Client{
				subClient:         subClient,
				stopMonitorSignal: make(chan bool),
				bmc:               bmcContract,
			},
		}

		bi := &blockinfo{}
		require.NoError(t, readBlockInfoFromAssets("assets/moonbase_blockinfo_315553.json", bi))
		subClient.On("GetFinalizedHead").Return(bi.Hash, nil).Once()
		subClient.On("GetHeader", bi.Hash).Return(&bi.Header, nil).Once()
		subClient.On("GetBlockHash", uint64(bi.BlockNumber)).Return(bi.Hash, nil).Once()
		subClient.On("GetHeader", bi.Hash).Return(&bi.Header, nil).Once()
		subClient.On("GetMetadata", bi.Hash).Return(&bi.MetaData, nil).Twice()
		subClient.On("GetStorageRaw", bi.StorageKey, bi.Hash).Return(&bi.SystemEventsStorageRaw, nil).Once()
		// 4 EVM_Logs event
		bmcContract.On("ParseMessage", mock.AnythingOfType("types.Log")).Return(nil, errors.New("abi: could not locate named method or event")).Times(4)

		err := r.ReceiveLoop(315553, 1, func(bu *chain.BlockUpdate, rps []*chain.ReceiptProof) {
			assert.EqualValues(t, bu.Height, 315553)
			assert.Equal(t, bi.Hash.Hex(), fmt.Sprintf("0x%x", bu.BlockHash))
			assert.Equal(t,
				fmt.Sprintf("0x%x", bi.ScaleEncodedHeader),
				fmt.Sprintf("0x%x", bu.Header),
			)
			assert.Equal(t, "0xf90180b9017bf1e8f0653422859dea6705ec5d86015a3c9f4c7c03eccbcb4bf858682956fb2886421300932c9abc4e9966ecf08dd3a5aa7087b448a88e54d18b3caebdbb2559c3f8744b25385e8e912f3965b85334a4524a6e15b21fb3c1b355d9e64df395b856a635970c046e6d6273802485ca9e9427894cb1864d725977e3c168171daf22bacf64c7ad5e0674c331730466726f6e890201e93015e1d2195ae2d73004a790db2e4bf394e40f14df3e0a2edd9dff0930e8a910ef0e6bfa9d8bb055f94e873f1df551b42df11d2cb053811279a1101e9c03fcf9cfa1b41ba3027ac3bbda9af6685440e8d89f12c7aca5987b334e91dbbaa4aa9356cb1e07577d7374463ec88709ce945f280b072b89f4bc8c0e70abf4b9b267c090d9ec032f7d7121f9bc2b2a8b9a6a06fd7f434cbebb963d6cfcb2e4206d2f43056e6d627301019cb74fccc8c86d67b5766b1c035e16ed4de18ecd091d4dd8724185eb28dbd1612983e904aafb984f05bd27443b6f8a56fbea955e208718d02e52eb28d0e62e89f800",
				fmt.Sprintf("0x%x", bu.Proof),
			)
			r.StopReceiveLoop()
		}, func() {})

		assert.NoError(t, err)
	})

	t.Run("should build StateProof when EVM Log events contains BMC SendMessage Event", func(t *testing.T) {
		subClient := &MockSubstrateClient{}
		ethClient, err := ethclient.Dial("wss://icon-btp.ecl.vn:34008")
		require.NoError(t, err)

		bmc, err := binding.NewBMC(EvmHexToAddress("0x5b5B619E6A040EBCB620155E0aAAe89AfA45D090"), ethClient)
		require.NoError(t, err)

		r := &Receiver{
			l:   log.New(),
			src: "btp://0x501.pra/0x5b5B619E6A040EBCB620155E0aAAe89AfA45D090",
			c: &Client{
				subClient:         subClient,
				ethClient:         ethClient,
				stopMonitorSignal: make(chan bool),
				bmc:               bmc,
			},
		}

		bi := &blockinfo{}
		require.NoError(t, readBlockInfoFromAssets("assets/moonriverlocal_blockinfo_143004.json", bi))
		subClient.On("GetFinalizedHead").Return(bi.Hash, nil).Once()
		subClient.On("GetHeader", bi.Hash).Return(&bi.Header, nil).Once()
		subClient.On("GetBlockHash", uint64(bi.BlockNumber)).Return(bi.Hash, nil).Once()
		subClient.On("GetHeader", bi.Hash).Return(&bi.Header, nil).Once()
		subClient.On("GetMetadata", bi.Hash).Return(&bi.MetaData, nil).Twice()
		subClient.On("GetStorageRaw", bi.StorageKey, bi.Hash).Return(&bi.SystemEventsStorageRaw, nil).Once()
		subClient.On("GetReadProof", bi.StorageKey, bi.Hash).Return(bi.SystemEventsReadProof, nil).Once()

		err = r.ReceiveLoop(143004, 1, func(bu *chain.BlockUpdate, rps []*chain.ReceiptProof) {
			assert.EqualValues(t, bu.Height, 143004)
			assert.Equal(t, bi.Hash.Hex(), fmt.Sprintf("0x%x", bu.BlockHash))
			assert.Equal(t,
				fmt.Sprintf("0x%x", bi.ScaleEncodedHeader),
				fmt.Sprintf("0x%x", bu.Header),
			)
			assert.Equal(t, "0xf8d8b8d4b02aebd1719933b78c76c3f51f6e1b2f760162f3b2f43c6818367dbadb8f7c2072ba0800049ac1e8cddb4d4de2fbe62e180ce05a2b329069f863a9855eb64534a846fa0cd7397f52d2d32573926eee56ca9a35f0c90d1c9a9610e21916c9b8aff1b9ba7608046e6d627380d43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d0466726f6e0901010db4dc2444f0ac86a3202819682e13bb5fd9d70ce01006f67720c1628f04745604bfafb68beb571aac735e8be629f3a13eb6e0263b873a9039f1103164da6eefb4f800",
				fmt.Sprintf("0x%x", bu.Proof),
			)
			assert.NotEmpty(t, rps)
			assert.Contains(t, rps, &chain.ReceiptProof{
				Proof: types.MustHexDecodeString("0xf91105a026aa394eea5630e07c48ae0c9558cef780d41e5e16056765bc8461851072c9d7f910e1b903623078383062666264383065313666333262363761303537396338383939343739316463336462353238613636653937626364303436306539343136383931326437663938393939613561383066353037333833633161356234343231356566343232353235626265656430323038666236333164646338343934616233336661353134346466653363623138383038343863366631333064613065346261323833316439313165376639346635646630616631633264383766636436616236396562363037383333623234383036383036343032383234326234623036376662373135633630336163386237303936333239366338623735633239613164623233663139353936316338306336636134383038313863646666376236313065633035626162636637633337393834356237386333316330663366623432623365323039633166323466643362326562633665383064366535303539396138356566323735626534363866303435616430396436366130306536663639666266653434343832623834393933393661666536376235383039393735353539666539306265313437333730313038333039363734373132663632643032653961323137306364366636333935376130376566366464396633383036643637633133666466313865306165643932333232623430626433363766616265333763313537643936356137613165633565653931323131323031306136383034353463323864373231393539376435643366313363323335616435356262396363303634373630656466303463343264653437623832303265323631356135383064353232613130376338623034633462383465376465613161333533653930666261663436366532303835323934333963386232366535313262353631396635383032303334376464303236373231376333366131313935356434373862613733363861623162306330396434336438373937623332643335313866643662333165383034623461383961333066386364333934656638336564623364623430353962633565656362343264346666386136343837653830303466346561636631613832383063363537633965663331353066616638633133633762386238376161643430653539626230666439343739613936663436643431666635376532633361623164b88c3078383034313030383035623337393265383133653833626465633930333930626461346338666662656232663266653337396461623636303436306535346266613864626431386630383038363463353836366335393533613162373630666338386362656665383531633434303938353036343863383564386463373637373432353731633463353962b90a1830783565643431653565313630353637363562633834363138353130373263396437653531333230303030303030303030303030303035303935613230393030303030303030303230303030303030313030303030303030303030303030303030303030303030303030303230303030303030323030303030303030303030303030303030303030303030303030303230303030303030333030303030303033303236626530326431643336363536363064323266663936323462376265303535316565316163393162313731363138333630663331663934353032343735653663636365316461383730323330626166373530633330303030303030303030303030303030303030303030303030303030303030303033303030303030306130303562356236313965366130343065626362363230313535653061616165383961666134356430393030343337626533353366323136636637653333363339313031666436313063353432653661306330313039313733666131633164386230346433346564623763316238313037303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303036303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030306130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030306330303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303033393632373437303361326632663330373833333265363936333666366532663633373833383635363233323334333833343339363133373633363536323331333636323338363636313335333333373636333536313338363233333337333836333336363136363334363133303332333433373030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303066386638663662383361363237343730336132663266333037383335333033313265373037323631326633303738333536323335343233363331333934353336343133303334333034353432343334323336333233303331333533353435333036313431343136353338333934313636343133343335343433303339333062383339363237343730336132663266333037383333326536393633366636653266363337383338363536323332333433383334333936313337363336353632333133363632333836363631333533333337363633353631333836323333333733383633333636313636333436313330333233343337386334333666363936653534373236313665373336363635373230386238366666383664303062383661663836386233333037383336363236353330333236343331363433333336333633353336333633303634333233323636363633393336333233343632333736323635333033353335333136353635333136313633333933313632303030303030303030303030303030303030616136383738333833303336333233303337333636313631333536353336333836363330333233313331333233313634333136333333363233343632333333393337333936343332333136313336363436333631363563386337383334343435353638326331356330303030303030303030303030303030303030303033303030303030306130306137666233383235613134363431393462376534613431376238636538333761663132343031653830383530643232333733626238346564316639656562353831633931336536643435643931386330356638623164393066306265313638663036613465363939346130303030303030303030303030303030303030303030303036626530326431643336363536363064323266663936323462376265303535316565316163393162383130363030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030363030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303038303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303063303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030333936323734373033613266326633303738333332653639363336663665326636383738333833303336333233303337333636313631333536353336333836363330333233313331333233313634333136333333363233343632333333393337333936343332333136313336363436333631363530303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303130303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303230303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303036303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030306331356330303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030316634303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030333434343535363030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303330303030303030623030366265303264316433363635363630643232666639363234623762653035353165653161633931623030303030303030303030303030303030303030303030303030303030303030303030303030303062666166623638626562353731616163373335653862653632396633613133656236653032363362383733613930333966313130333136346461366565666234303030313030303030333030303030303030303062386330656639343032303030303030303030303030b90216307839656161333934656561353633306530376334386165306339353538636566373239386638306538633135333164363437363933306334376334626362383335653062613538626535633234373835663438636134623564303861396236393439626335653838306663343061663137653266316136643862346535393564313235313831663066343434623761633161653066643438656665633633663163626230303263666534633566303638346130323261333464643862666132626161663434663137326237313030343031383035643362666532656437343364626235616339323833383931356433383665643638663163663537323962373530623065313130353837616336356264303330383066333136623864326462393463333136616466613932633137386165623962376361353531383032616663333038396331623466343432393337656665636163383061313561333064303233386534373130376535643062376666643532663164653131396563316135666264663130343731396636333732633237316366323936383032376238366263333763663437663135656436613331343535656166343837643030343332393536313730626666343130653263366433336333396565366638373435663039636365396338383834363962623161306463656161313239363732656638326336643032323036643666366636653632363137333635b8b830783830383130343830323266643564336262346239386130666661353135666533633039333764356231636262383161386632626231613263363263316562653365386139353361313534356538643433346436313235623430343433666531316664323932643133613431303033303030303030383037646136633264383533303366303132326235653365333336333363646639643665633936663137306166373361376165336566313966353534646366646665"),
			})
			r.StopReceiveLoop()
		}, func() {})

		assert.NoError(t, err)
	})
}
